
HerbListSize = 56;

HerbList = {
{"Desecrated Herb","Shadow Pigment","Misty Pigment","Ink of Dreams","Starlight Ink"},
{"Fool's Cap","Shadow Pigment","Misty Pigment","Ink of Dreams","Starlight Ink"},
{"Snow Lily","Shadow Pigment","Misty Pigment","Ink of Dreams","Starlight Ink"},
{"Silkweed","Shadow Pigment","Misty Pigment","Ink of Dreams","Starlight Ink"},
{"Rain Poppy","Shadow Pigment","Misty Pigment","Ink of Dreams","Starlight Ink"},
{"Green Tea Leaf","Shadow Pigment","Misty Pigment","Ink of Dreams","Starlight Ink"},
{"Twilight Jasmine","Ashen Pigment","Burning Embers","Blackfallow Ink","Inferno Ink"},
{"Whiptail","Ashen Pigment","Burning Embers","Blackfallow Ink","Inferno Ink"},
{"Heartblossom","Ashen Pigment","Burning Embers","Blackfallow Ink","Inferno Ink"},
{"Azshara's Veil","Ashen Pigment","Burning Embers","Blackfallow Ink","Inferno Ink"},
{"Stormvine","Ashen Pigment","Burning Embers","Blackfallow Ink","Inferno Ink"},
{"Cinderbloom","Ashen Pigment","Burning Embers","Blackfallow Ink","Inferno Ink"},
{"Lichbloom","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Icethorn","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Adder's Tongue","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Fire Leaf","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Talandra's Rose","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Tiger Lily","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Deadnettle","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Goldclover","Azure Pigment","Icy Pigment","Ink of the Sea","Snowfall Ink"},
{"Netherbloom","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Nightmare Vine","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Mana Thistle","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Ancient Lichen","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Ragveil","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Terocone","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Dreaming Glory","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Felweed","Nether Pigment","Ebon Pigment","Ethereal Ink","Darkflame Ink"},
{"Icecap","Silvery Pigment","Sapphire Pigment","Shimmering Ink","Ink of the Sky"},
{"Sorrowmoss","Silvery Pigment","Sapphire Pigment","Shimmering Ink","Ink of the Sky"},
{"Mountain Silversage","Silvery Pigment","Sapphire Pigment","Shimmering Ink","Ink of the Sky"},
{"Dreamfoil","Silvery Pigment","Sapphire Pigment","Shimmering Ink","Ink of the Sky"},
{"Golden Sansam","Silvery Pigment","Sapphire Pigment","Shimmering Ink","Ink of the Sky"},
{"Gromsblood","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Ghost Mushroom","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Blindweed","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Sungrass","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Arthas' Tears","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Purple Lotus","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Firebloom","Violet Pigment","Ruby Pigment","Celestial Ink","Fiery Ink"},
{"Dragon's Teeth","Emerald Pigment","Indigo Pigment","Jadefire Ink","Royal Ink"},
{"Khadgar's Whisker","Emerald Pigment","Indigo Pigment","Jadefire Ink","Royal Ink"},
{"Goldthorn","Emerald Pigment","Indigo Pigment","Jadefire Ink","Royal Ink"},
{"Fadeleaf","Emerald Pigment","Indigo Pigment","Jadefire Ink","Royal Ink"},
{"Liferoot","Golden Pigment","Burnt Pigment","Lion's Ink","Dawnstar Ink"},
{"Kingsblood","Golden Pigment","Burnt Pigment","Lion's Ink","Dawnstar Ink"},
{"Wild Steelbloom","Golden Pigment","Burnt Pigment","Lion's Ink","Dawnstar Ink"},
{"Grave Moss","Golden Pigment","Burnt Pigment","Lion's Ink","Dawnstar Ink"},
{"Bruiseweed","Dusky Pigment","Verdant Pigment","Midnight Ink","Hunter's Ink"},
{"Stranglekelp","Dusky Pigment","Verdant Pigment","Midnight Ink","Hunter's Ink"},
{"Mageroyal","Dusky Pigment","Verdant Pigment","Midnight Ink","Hunter's Ink"},
{"Swiftthistle","Dusky Pigment","Verdant Pigment","Midnight Ink","Hunter's Ink"},
{"Briarthorn","Dusky Pigment","Verdant Pigment","Midnight Ink","Hunter's Ink"},
{"Earthroot","Alabaster Pigment","","Ivory Ink","Moonglow Ink"},
{"Silverleaf","Alabaster Pigment","","Ivory Ink","Moonglow Ink"},
{"Peacebloom","Alabaster Pigment","","Ivory Ink","Moonglow Ink"}
};

HerbID = {
89639,
79011,
79010,
72235,
72237,
72234,
52987,
52988,
52986,
52985,
52984,
52983,
36905,
36906,
36903,
39970,
36907,
36904,
37921,
36901,
22791,
22792,
22793,
22790,
22787,
22789,
22786,
22785,
13467,
13466,
13465,
13463,
13464,
8846,
8845,
8839,
8838,
8836,
8831,
4625,
3819,
3358,
3821,
3818,
3357,
3356,
3355,
3369,
2453,
3820,
785,
2452,
2450,
2449,
765,
2447
};

HerbSkill = {
500,
500,
500,
500,
500,
500,
475,
475,
450,
450,
425,
425,
325,
325,
325,
325,
325,
325,
325,
325,
275,
275,
275,
275,
275,
275,
275,
275,
225,
225,
225,
225,
225,
175,
175,
175,
175,
175,
175,
175,
125,
125,
125,
125,
75,
75,
75,
75,
25,
25,
25,
25,
25,
1,
1,
1
};

HerbPigment = {
{79251,79253,79254,79255},
{79251,79253,79254,79255},
{79251,79253,79254,79255},
{79251,79253,79254,79255},
{79251,79253,79254,79255},
{79251,79253,79254,79255},
{61979,61980,61978,61981},
{61979,61980,61978,61981},
{61979,61980,61978,61981},
{61979,61980,61978,61981},
{61979,61980,61978,61981},
{61979,61980,61978,61981},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39343,43109,43126,43127},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39342,43108,43124,43125},
{39341,43107,43122,43123},
{39341,43107,43122,43123},
{39341,43107,43122,43123},
{39341,43107,43122,43123},
{39341,43107,43122,43123},
{39340,43106,43120,43121},
{39340,43106,43120,43121},
{39340,43106,43120,43121},
{39340,43106,43120,43121},
{39340,43106,43120,43121},
{39340,43106,43120,43121},
{39340,43106,43120,43121},
{39339,43105,43118,43119},
{39339,43105,43118,43119},
{39339,43105,43118,43119},
{39339,43105,43118,43119},
{39338,43104,43116,43117},
{39338,43104,43116,43117},
{39338,43104,43116,43117},
{39338,43104,43116,43117},
{39334,43103,39774,43115},
{39334,43103,39774,43115},
{39334,43103,39774,43115},
{39334,43103,39774,43115},
{39334,43103,39774,43115},
{39151,0,37101,39469},
{39151,0,37101,39469},
{39151,0,37101,39469}
};

PigToInk = {
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,2},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{2,1},
{1,2},
{1,2},
{1,2}
};

MillingFilterIndex = nil;
MillingFrameSize = 8;
MillingSelctionIndex = 0;
MAX_MILLING_REAGENTS = 8;
MillingFontRed = { r = 1.00, g = 0.0, b = 0.0, font = GameFontNormalLeftRed };
MillingFontGrey = { r = 0.50, g = 0.50, b = 0.50, font = GameFontNormalLeftGrey };
MillingFrameItemInfo = 0;
MillingFrameFilterHaveMats = false;

SLASH_MILLING1 = '/milling';
function SlashCmdList.MILLING(msg, editbox)
	--print("SlashCmdList.MILLING");
	if(not MillingFrame:IsShown()) then
		MillingFrame:Show();
	else
		MillingFrame:Hide();
	end
		
end

-- Initializes the UI
function MillingFrame_OnLoad()
	--print("MillingFrame_OnLoad()");
	
	--hides stuff from the TradeSkill frame I'm not using
	MillingFrameTabardBackground:Hide();
	MillingFrameTabardEmblem:Hide();
	MillingFrameTabardBorder:Hide();
	MillingFrameExpandButtonFrame:Hide();
	MillingFramePortrait:Show();
	
	MillingFrameTitleText:SetText("Milling");
	MillingFramePortrait:SetTexture("Interface\\ICONS\\Ability_Miling");
	
	MillingFrameMillButton:SetAttribute("type", "spell");
	MillingFrameMillButton:SetAttribute("spell", "Milling");
	
	-- create the buttons for the scroll frame
	--print("Creating Milling Frame Entry Buttons");
	local prior;
	for i=1,MillingFrameSize do
		local button = CreateFrame("Button", "MillingFrameEntry"..i, MillingFrame, "MillingFrameButtonTemplate");
		-- first button is Anchored to the Scroll Frame,
		-- the rest are Anchored to the prior button
		if(i==1) then
			button:SetPoint("TOPLEFT", MillingFrameExpandButtonFrame, "BOTTOMLEFT", 8, 5);
		else
			button:SetPoint("TOPLEFT", prior, "BOTTOMLEFT");
		end
		
		prior = button;
	end
end

function MillingFrame_OnShow()
	--print("MillingFrame_OnShow()");
	MillingFrameMillButton:Disable();
	MillingFrameMillAllButton:Disable();
	MillingFrameDecrementButton:Disable();
	MillingFrameIncrementButton:Disable();
	
	if ( MillingSelctionIndex == 0 ) then
		MillingSelctionIndex = 1;
	end	
	
	--print("Updating FauxScrollFrame");
	FauxScrollFrame_SetOffset(MillingFrameListScrollFrame, 0);
	MillingFrameListScrollFrameScrollBar.doNotHide = true;
	MillingFrameListScrollFrameScrollBar:SetMinMaxValues(0, 0); 
	MillingFrameListScrollFrameScrollBar:SetValue(0);

	--print("Setting Inscription Level");
	local inscriptionRank, inscriptionMaxRank, inscriptionModifier;
	inscriptionRank, inscriptionMaxRank, inscriptionModifier = MillingFrame_GetInscriptionLevels();
	--print("Rank: "..inscriptionRank..", Max: "..inscriptionMaxRank..", Modifier: "..inscriptionModifier);
	MillingFrameRankFrame:SetStatusBarColor(0.0, 0.0, 1.0, 0.5);
	MillingFrameRankFrameBackground:SetVertexColor(0.0, 0.0, 0.75, 0.5);
	MillingFrameRankFrame:SetMinMaxValues(0, inscriptionMaxRank);
	MillingFrameRankFrame:SetValue(inscriptionRank);
	if ( inscriptionModifier > 0 ) then
		MillingFrameRankFrameSkillRank:SetFormattedText(TRADESKILL_RANK_WITH_MODIFIER, inscriptionRank, inscriptionModifier, inscriptionMaxRank);
	else
		MillingFrameRankFrameSkillRank:SetFormattedText(TRADESKILL_RANK, inscriptionRank, inscriptionMaxRank);
	end
	
	MillingFrameRankFrame:Show();

	-- TradeSkillOnlyShowMakeable(TradeSkillFrame.filterTbl.hasMaterials);
	-- TradeSkillOnlyShowSkillUps(TradeSkillFrame.filterTbl.hasSkillUp);
	-- TradeSkillSetFilter(-1, -1);
	MillingFilterIndex = nil;
	MillingFrame_Update();

end

function MillingFrame_GetInscriptionLevels()
	local prof1, prof2, archaeology, fishing, cooking, firstAid;
	local name, texture, rank, maxRank, numSpells, spelloffset, skillLine, rankModifier, specializationIndex, specializationOffset;

	prof1, prof2, archaeology, fishing, cooking, firstAid = GetProfessions();

	if(prof1 ~= nil) then
		name, texture, rank, maxRank, numSpells, spelloffset, skillLine, rankModifier, specializationIndex, specializationOffset = GetProfessionInfo(prof1);
		--print("prof1: "..name);
		if(name ~= "Inscription") then
			if(prof2 ~= nil) then
				name, texture, rank, maxRank, numSpells, spelloffset, skillLine, rankModifier, specializationIndex, specializationOffset = GetProfessionInfo(prof2);
				--print("prof2: "..name);
				if(name ~= "Inscription") then
					return 0, 0, 0;
				end
			end
		end
	end
	-- if I get here, should have the inscription info
	return rank, maxRank, rankModifier;
end

function MillingFrame_OnEvent(self, event, ...)
	if (event == "PLAYER_ENTERING_WORLD") then
		self:RegisterEvent("BAG_UPDATE");
		self:RegisterEvent("GET_ITEM_INFO_RECEIVED");
	elseif (MillingFrame:IsShown()) then
		if (event == "BAG_UPDATE") then
			MillingFrame_Update();
		elseif (MillingFrameItemInfo and event == "GET_ITEM_INFO_RECEIVED") then
			MillingFrameItemInfo = 0;
			MillingFrame_SetSelection();
		end
	end
	
end

function MillingFrame_Update()
	--print("MillingFrame_Update()");
	local scrollOffset = FauxScrollFrame_GetOffset(MillingFrameListScrollFrame);
	
	MillingFrameHighlightFrame:Hide();
	
	local listSize = HerbListSize;
	if(MillingFilterIndex) then
		listSize = table.getn(MillingFilterIndex);
	else
		listSize = HerbListSize;
	end
	local displaySize = MillingFrameSize;
	local hasFilterBar = MillingFrameFilterBar:IsShown();
	if hasFilterBar then
		displaySize = displaySize - 1;
		listSize = listSize + 1;
	end
	
	-- ScrollFrame update
	--print("FauxScrollFrame_Update()");
	FauxScrollFrame_Update(MillingFrameListScrollFrame, listSize, MillingFrameSize, 16, nil, nil, nil, MillingFrameHighlightFrame, 293, 316, true );

	local herbName, numAvailable;
	local listIndex, buttonIndex, skillButton, skillButtonText, skillButtonCount;
	local rank, maxRank, modifier = MillingFrame_GetInscriptionLevels();
	rank = rank + modifier;
	for i=1, displaySize, 1 do
		listIndex = i + scrollOffset;
		--print("Button: "..i..", index: "..listIndex);
		if(MillingFilterIndex) then
			listIndex = MillingFilterIndex[listIndex];
			-- if MillingFilterIndex doesn't have an entry for ListIndex
			-- set it larger thatn the HerbListSize, so the button is hidden
			if( not listIndex) then  
				listIndex = HerbListSize + 1;
			end
		end
		
		if hasFilterBar then
			buttonIndex = i+1;
		else
			buttonIndex = i;
		end
		
		skillButton = _G["MillingFrameEntry"..buttonIndex];
		skillButtonText = _G["MillingFrameEntry"..buttonIndex.."Text"];
		skillButtonCount = _G["MillingFrameEntry"..buttonIndex.."Count"];
		skillButtonSubSkillRankBar = _G["MillingFrameEntry"..buttonIndex.."SubSkillRankBar"];
		skillButtonSubSkillRankBar:Hide();
		if ( listIndex <= HerbListSize ) then
			herbName = HerbList[listIndex][1];
			numAvailable = math.floor(GetItemCount(herbName, false, false)/5);
			local color;
			if ( HerbSkill[listIndex] > rank ) then
				color = MillingFontRed;
			else
				color = MillingFontGrey;
			end
			if ( color ) then
				skillButton:SetNormalFontObject(color.font);
				skillButtonText:SetVertexColor(color.r, color.g, color.b);
				skillButtonCount:SetVertexColor(color.r, color.g, color.b);
				skillButton.r = color.r;
				skillButton.g = color.g;
				skillButton.b = color.b;
				skillButton.font = color.font;
			end
			
			local textWidth = 270;
			skillButton:GetNormalTexture():SetPoint("LEFT", 3, 0);
			skillButton:GetDisabledTexture():SetPoint("LEFT", 3, 0);
			skillButton:GetHighlightTexture():SetPoint("LEFT", 3, 0);
			skillButton:SetID(listIndex);
			skillButton:Show();
  			
			skillButton:SetNormalTexture("");
			_G["MillingFrameEntry"..buttonIndex.."Highlight"]:SetTexture("");
			if ( numAvailable <= 0 ) then
				--print("Setting button text and count: 0");
				skillButton:SetText(herbName);
				skillButtonText:SetWidth(textWidth);
				skillButtonCount:SetText("");
			else
				--print("Setting button text and count: "..numAvailable);
				skillButtonCount:SetText("["..numAvailable.."]");
				MillingFrameDummyString:SetText(herbName);
				local nameWidth = MillingFrameDummyString:GetWidth();
				local countWidth = skillButtonCount:GetWidth();
				skillButtonText:SetText(herbName);
				if ( nameWidth + 2 + countWidth > textWidth) then
					skillButtonText:SetWidth(textWidth - 2 - countWidth);
				else
					skillButtonText:SetWidth(0);
				end
			end
			
			-- Place the highlight and lock the highlight state
			if ( MillingSelctionIndex == listIndex ) then
				--print("Highlighting "..listIndex);
				MillingFrameHighlightFrame:SetPoint("TOPLEFT", "MillingFrameEntry"..buttonIndex, "TOPLEFT", 0, 0);
				MillingFrameHighlightFrame:Show();
				if(HerbSkill[listIndex] <= rank) then
					skillButtonText:SetVertexColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
					skillButtonCount:SetVertexColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
				end
				
				skillButton:LockHighlight();
				skillButton.isHighlighted = true;
				
				if(numAvailable > 0) then  -- need to check inscription level
					--MillingFrameMillAllButton:Enable();
					MillingFrameMillButton:Enable();
				else
					--MillingFrameMillAllButton:Disable();
					MillingFrameMillButton:Disable();
				end
			else
				skillButton:UnlockHighlight();
				skillButton.isHighlighted = false;
			end
		else
			skillButton:Hide();
		end -- if( listIndex <= HerbListSize )
	end -- for
	MillingFrame_SetSelection();
end

function MillingFrame_SetSelection()
	--print("MillingFrame_SetSelection(), "..MillingSelctionIndex);
	local herbName, _, _, _, _, _, _, _, _, texture = GetItemInfo(HerbID[MillingSelctionIndex]);
	if(not herbName) then
		MillingFrameItemInfo = 1;
		return; -- or maybe clear this frame?
	end
	
	-- local skillName, skillType, numAvailable, isExpanded, altVerb = GetTradeSkillInfo(id);
	-- local creatable = 1;
	-- if ( not skillName ) then
		-- creatable = nil;
	-- end
	--TradeSkillHighlightFrame:Show();

	MillingFrameSkillIcon:SetNormalTexture(texture);
	MillingFrameSkillIcon:SetID(HerbID[MillingSelctionIndex]); -- for tooltip
	MillingFrameSkillName:SetText(herbName);
	local itemCount = GetItemCount(herbName, false, false);
	if ( itemCount >= 100 ) then
		itemCount = "*";
	end
	MillingFrameSkillIconCount:SetText(itemCount.."/5");
	

	-- Reagents
	local numReagents = 4;
	MillingFrameReagentLabel:Show();
	for i=1, numReagents, 1 do
		--print("reagent: "..i);
		local reagent = _G["MillingFrameReagent"..i]
		if(HerbPigment[MillingSelctionIndex][i] == 0) then
			reagent:Hide();
		else
			reagent:SetID(HerbPigment[MillingSelctionIndex][i]); -- used for the tooltip
			local reagentName, _, _, _, _, _, _, _, _, reagentTexture = GetItemInfo(HerbPigment[MillingSelctionIndex][i]);
			if(not reagentName) then
				MillingFrameItemInfo = 1;
				return;
			end
			local playerReagentCount = GetItemCount(reagentName, false, false);
			local name = _G["MillingFrameReagent"..i.."Name"];
			local count = _G["MillingFrameReagent"..i.."Count"];
			reagent:Show();
			SetItemButtonTexture(reagent, reagentTexture);
			name:SetFontObject(GameFontHighlight);
			if(i > 2) then
				local numPigments = PigToInk[MillingSelctionIndex][i-2];
				if(numPigments == 1) then
					name:SetText(reagentName.." ("..(PigToInk[MillingSelctionIndex][i-2]).." pigment)");
				elseif(numPigments > 1) then
					name:SetText(reagentName.." ("..(PigToInk[MillingSelctionIndex][i-2]).." pigments)");
				end
				if(name:IsTruncated()) then
					name:SetFontObject(GameFontHighlightSmall);
			end
			else
				name:SetText(reagentName);
			end
			-- Grayout items
			if ( playerReagentCount == 0 ) then
				SetItemButtonTextureVertexColor(reagent, 0.5, 0.5, 0.5);
				name:SetTextColor(GRAY_FONT_COLOR.r, GRAY_FONT_COLOR.g, GRAY_FONT_COLOR.b);
			else
				SetItemButtonTextureVertexColor(reagent, 1.0, 1.0, 1.0);
				name:SetTextColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
			end
			if ( playerReagentCount >= 100 ) then
				playerReagentCount = "*";
			end
			count:SetText(playerReagentCount);
		end
	end
	
	for i=numReagents + 1, MAX_MILLING_REAGENTS, 1 do
		_G["MillingFrameReagent"..i]:Hide();
	end

	MillingFrameRequirementLabel:Hide();
	MillingFrameRequirementText:SetText("");
end

function MillingFrameSearch_OnTextChanged(self)
	MillingFrameFilterHerbList();
end

function MillingFrameHaveMaterials(herb)
	return GetItemCount(herb, false, false) >= 5;
end

function MillingFrameTextFilter(index, text)
	if(strfind(strlower(HerbList[index][1]), text)
	  or strfind(strlower(HerbList[index][2]), text)
	  or strfind(strlower(HerbList[index][3]), text)
	  or strfind(strlower(HerbList[index][4]), text)
	  or strfind(strlower(HerbList[index][5]), text)) then
		return true;
	end
	return false;
end

function MillingFrameFilterHerbList()
	--print("MillingFrameFilterHerbList");
	local text = strlower(MillingFrameSearchBox:GetText());
	if(text == "search") then
		text = "";
	end
	local haveMats = MillingFrameFilterHaveMats;
	local search = not(text == "");
	
	if(not search and not haveMats) then
		--print("not filtering");
		MillingFilterIndex = nil;
		MillingFrame_Update();
		return;
	end
	
	local index = 1;
	MillingFilterIndex = {};
	if(search and haveMats) then
		--print("search and filter");
		for i=1,HerbListSize do
			if(MillingFrameHaveMaterials(HerbList[i][1]) 
			  and MillingFrameTextFilter(i, text)) then
				MillingFilterIndex[index] = i;
				index = index + 1;
			end
		end
	elseif(haveMats) then
		--print("filter");
		for i=1,HerbListSize do
			if(MillingFrameHaveMaterials(HerbList[i][1])) then
				MillingFilterIndex[index] = i;
				index = index + 1;
			end
		end
		--print(index.." items");
	elseif(search) then
		--print("search");
		for i=1,HerbListSize do
			if(MillingFrameTextFilter(i, text)) then
				MillingFilterIndex[index] = i;
				index = index + 1;
			end
		end
	end
	
	MillingFrame_Update();
end

function MillingFrameFilterDropDown_OnLoad(self)
	UIDropDownMenu_Initialize(self, MillingFrameFilterDropDown_Initialize, "MENU");
	MillingFrameFilterDropDownText:SetJustifyH("CENTER");
	MillingFrameFilterDropDownButton:Show();
end

function MillingFrameUpdateFilterBar()

	local filterText = CRAFT_IS_MAKEABLE;
	
	if not MillingFrameFilterHaveMats then
		MillingFrameFilterBar:Hide();
		MillingFrameEntry1:Show();
	else
		MillingFrameFilterBar:Show();	
		MillingFrameEntry1:Hide();
		MillingFrameFilterBarText:SetText(FILTER..": "..filterText);
	end

	MillingFrameListScrollFrameScrollBar:SetValue(0);
	FauxScrollFrame_SetOffset(MillingFrameListScrollFrame, 0);
	MillingFrameFilterHerbList();
end

function MillingFrameFilterDropDown_Initialize(self, level)
	local info = UIDropDownMenu_CreateInfo();
	info.text = CRAFT_IS_MAKEABLE;
	info.func = 	function() 
						MillingFrameFilterHaveMats  = not MillingFrameFilterHaveMats;
						MillingFrameUpdateFilterBar();
					end 
	info.keepShownOnClick = true;
	info.checked = 	MillingFrameFilterHaveMats;
	info.isNotRadio = true;
	UIDropDownMenu_AddButton(info, level)
end

function MillingFrame_Consolidate(herb, target_bag, target_slot)
	print("MillingFrame_Consolidate("..herb..", "..target_bag..", "..target_slot..")");
	for bag=target_bag,4 do
		for slot=target_slot+1,GetContainerNumSlots(bag) do
			local id = GetContainerItemID(bag, slot);
			if (id == herb) then
				print("Consolidating with "..bag..", "..slot);
				PickupContainerItem(bag, slot);
				PickupContainerItem(target_bag, target_slot);
				local _, count = GetContainerItemInfo(target_bag, target_slot);
				if(count >= 5) then
					MillingFrame_Consolidate(herb, target_bag, target_slot);
					return;
				end -- else keep looking
			end
		end
	end
end

function MillingFrameEntry_OnClick(self, button)
	--print("MillingEntry_OnClick");
	if ( button == "LeftButton" ) then
		MillingSelctionIndex = self:GetID();
		MillingFrame_Update();
	end
end
  
function MillingFrame_GetHerbBagSlot(herb)
	--print("MillingFrame_GetHerbBagSlot("..herb..")");
	for bag=0,4 do
		for slot=1,GetContainerNumSlots(bag) do
			local id = GetContainerItemID(bag, slot);
			--print(bag..", "..slot..": "..id);
			if id then
				if (id == herb) then
					--print("found herb");
					local _, count = GetContainerItemInfo(bag, slot);
					if(count >= 5) then
						--print("returning "..bag..", "..slot);
						return bag, slot; 
					end
				end
			end
		end
	end
end

function MillingFrameMillAllButton_OnClick()
	--print("MillingFrameMillAllButtonOnClick()");
	--local bag, slot = MillingFrame_GetHerbBagSlot(HerbID[MillingSelctionIndex]);
end

function MillingFrameMillButton_PreClick()
	--print("MillingFrameMillButtonPreClick()");
	local bag, slot = MillingFrame_GetHerbBagSlot(HerbID[MillingSelctionIndex]);
	MillingFrameMillButton:SetAttribute("target-bag", bag);
	MillingFrameMillButton:SetAttribute("target-slot", slot);
end

function MillingFrameMillButton_PostClick()
	--print("MillingFrameMillButtonPostClick()");
	--MillingFrame_Update();
end

function MillingFrameEntryButton_OnEnter(self)
	--print("MillingFrameEntryButton_OnEnter()");
	self.count:SetVertexColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
	self.skillup.icon:SetVertexColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
	self.skillup.countText:SetVertexColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
	
	self.text:SetFontObject(GameFontHighlightLeft);
	self.text:SetVertexColor(HIGHLIGHT_FONT_COLOR.r, HIGHLIGHT_FONT_COLOR.g, HIGHLIGHT_FONT_COLOR.b);
	if ( self.SubSkillRankBar.currentRank and self.SubSkillRankBar.maxRank) then
		self.SubSkillRankBar.Rank:SetText(self.SubSkillRankBar.currentRank.."/"..self.SubSkillRankBar.maxRank);
	end
end

function MillingFrameEntryButton_OnLeave(self)
	--print("MillingFrameEntryButton_OnLeave()");
	if ( not self.isHighlighted ) then
		self.count:SetVertexColor(self.r, self.g, self.b);
		self.skillup.icon:SetVertexColor(self.r, self.g, self.b);
		self.skillup.countText:SetVertexColor(self.r, self.g, self.b);
		
		self.text:SetFontObject(self.font);
		self.text:SetVertexColor(self.r, self.g, self.b);
		self.SubSkillRankBar.Rank:SetText("");
	end
end

function MillingFrameIncrement_OnClick()
	if ( MillingFrameInputBox:GetNumber() < 100 ) then
		MillingFrameInputBox:SetNumber(MillingFrameInputBox:GetNumber() + 1);
	end
end

function MillingFrameDecrement_OnClick()
	if ( MillingFrameInputBox:GetNumber() > 0 ) then
		MillingFrameInputBox:SetNumber(MillingFrameInputBox:GetNumber() - 1);
	end
end